<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 테스트 - HowAreYou</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .token-display {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 헤더 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">회원가입 테스트</h1>
                <p class="text-gray-600">OAuth2 로그인 후 프로필 설정</p>
            </div>

            <!-- 로딩 스피너 -->
            <div id="loading" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                            <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">처리 중...</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">잠시만 기다려주세요.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 콘텐츠 -->
            <main class="space-y-6">
                <!-- OAuth2 정보 카드 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">OAuth2 로그인 정보</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-md font-medium text-gray-700 mb-2">로그인 상태</h4>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">공급자</dt>
                                    <dd id="oauthProvider" class="text-sm text-gray-900">-</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">프로필 완료 여부</dt>
                                    <dd id="profileCompleted" class="text-sm text-gray-900">-</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Access Token</dt>
                                    <dd id="accessTokenStatus" class="text-sm text-gray-900">-</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>

                <!-- 회원가입 폼 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">프로필 설정</h3>
                    <form id="signupForm" class="space-y-4">
                        <div>
                            <label for="membername" class="block text-sm font-medium text-gray-700 mb-2">사용자명 (Membername)</label>
                            <input type="text" id="membername" name="membername" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="사용자명을 입력하세요">
                            <p class="text-sm text-gray-500 mt-1">영문, 숫자, 언더스코어만 사용 가능합니다.</p>
                        </div>
                        
                        <div>
                            <label for="nickname" class="block text-sm font-medium text-gray-700 mb-2">닉네임</label>
                            <input type="text" id="nickname" name="nickname" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="닉네임을 입력하세요">
                        </div>
                        
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">자기소개</label>
                            <textarea id="bio" name="bio" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="자기소개를 입력하세요"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 mb-2">성별</label>
                                <select id="gender" name="gender"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">선택하세요</option>
                                    <option value="MALE">남성</option>
                                    <option value="FEMALE">여성</option>
                                    <option value="OTHER">기타</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="birthYear" class="block text-sm font-medium text-gray-700 mb-2">출생년도</label>
                                <input type="number" id="birthYear" name="birthYear" min="1900" max="2024"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="예: 1990">
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                프로필 설정 완료
                            </button>
                            <button type="button" onclick="skipProfileSetup()"
                                    class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                나중에 설정
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 토큰 정보 카드 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">토큰 정보</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                            <div id="accessToken" class="token-display">토큰이 없습니다.</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Refresh Token</label>
                            <div id="refreshToken" class="token-display">토큰이 없습니다.</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="copyAccessToken()" 
                                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                Access Token 복사
                            </button>
                            <button onclick="copyRefreshToken()" 
                                    class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                Refresh Token 복사
                            </button>
                            <button onclick="decodeToken()" 
                                    class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                토큰 디코딩
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 디버깅 정보 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">디버깅 정보</h3>
                    <div class="space-y-4">
                        <button onclick="debugInfo()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            디버깅 정보 확인
                        </button>
                        <div id="debugInfo" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                            <pre id="debugInfoContent" class="text-sm text-gray-700"></pre>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 토큰 디코딩 모달 -->
    <div id="tokenModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">JWT 토큰 디코딩</h3>
                <div id="tokenDecodeResult" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <pre class="text-sm text-gray-700"></pre>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="closeTokenModal()" 
                            class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        닫기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentAccessToken = '';
        let currentRefreshToken = '';
        let currentUser = null;

        // 페이지 로드 시 초기화
        window.onload = function() {
            handleOAuthSuccess();
        };

        // OAuth2 로그인 성공 처리
        async function handleOAuthSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const oauthSuccess = urlParams.get('oauth_success');
            const provider = urlParams.get('provider');
            const profileCompleted = urlParams.get('profile_completed');
            const accessToken = urlParams.get('access_token');
            
            if (oauthSuccess === 'true') {
                console.log('=== OAuth2 로그인 성공 ===');
                console.log('공급자:', provider);
                console.log('프로필 완료 여부:', profileCompleted);
                console.log('Access Token:', accessToken ? accessToken.substring(0, 50) + '...' : '없음');
                
                // URL 파라미터 정리
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // OAuth2 정보 표시
                document.getElementById('oauthProvider').textContent = provider || '-';
                document.getElementById('profileCompleted').textContent = profileCompleted === 'true' ? '완료' : '미완료';
                document.getElementById('accessTokenStatus').textContent = accessToken ? '설정됨' : '없음';
                
                // Access Token 설정
                if (accessToken) {
                    currentAccessToken = accessToken;
                    updateTokenDisplay();
                }
                
                // 프로필이 완료된 경우 메인 페이지로 리다이렉트
                if (profileCompleted === 'true') {
                    window.location.href = '/test-login.html';
                }
            }
        }

        // 회원가입 폼 제출
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const membername = formData.get('membername');
            const nickname = formData.get('nickname');
            const bio = formData.get('bio');
            const gender = formData.get('gender');
            const birthYear = formData.get('birthYear');
            
            try {
                showLoading(true);
                
                // 1. Membername 설정
                const membernameResponse = await fetch('/api/members/membername', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    body: JSON.stringify({ membername })
                });
                
                if (!membernameResponse.ok) {
                    const error = await membernameResponse.json();
                    throw new Error(`Membername 설정 실패: ${error.message}`);
                }
                
                // 2. 프로필 설정
                const profileData = {
                    nickname: nickname,
                    bio: bio || '',
                    gender: gender || null,
                    birthYear: birthYear ? parseInt(birthYear) : null
                };
                
                const profileResponse = await fetch('/api/members/me', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (!profileResponse.ok) {
                    const error = await profileResponse.json();
                    throw new Error(`프로필 설정 실패: ${error.message}`);
                }
                
                showNotification('프로필 설정이 완료되었습니다!', 'success');
                
                // 메인 페이지로 리다이렉트
                setTimeout(() => {
                    window.location.href = '/test-login.html';
                }, 2000);
                
            } catch (error) {
                console.error('회원가입 실패:', error);
                showNotification(`회원가입 실패: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        });

        // 프로필 설정 건너뛰기
        function skipProfileSetup() {
            if (confirm('프로필 설정을 건너뛰시겠습니까? 나중에 설정할 수 있습니다.')) {
                window.location.href = '/test-login.html';
            }
        }

        // 토큰 표시 업데이트
        function updateTokenDisplay() {
            document.getElementById('accessToken').textContent = currentAccessToken || '토큰이 없습니다.';
            document.getElementById('refreshToken').textContent = currentRefreshToken || '토큰이 없습니다.';
        }

        // 토큰 복사 함수들
        function copyAccessToken() {
            if (currentAccessToken) {
                navigator.clipboard.writeText(currentAccessToken);
                showNotification('Access Token이 복사되었습니다.', 'success');
            }
        }

        function copyRefreshToken() {
            if (currentRefreshToken) {
                navigator.clipboard.writeText(currentRefreshToken);
                showNotification('Refresh Token이 복사되었습니다.', 'success');
            }
        }

        // 토큰 디코딩
        function decodeToken() {
            if (!currentAccessToken) {
                showNotification('디코딩할 토큰이 없습니다.', 'error');
                return;
            }

            try {
                const parts = currentAccessToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('유효하지 않은 JWT 토큰입니다.');
                }

                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));

                const result = {
                    header: header,
                    payload: payload,
                    signature: parts[2] + '...'
                };

                const modal = document.getElementById('tokenModal');
                const content = document.querySelector('#tokenDecodeResult pre');
                content.textContent = JSON.stringify(result, null, 2);
                modal.classList.remove('hidden');
            } catch (error) {
                showNotification(`토큰 디코딩 실패: ${error.message}`, 'error');
            }
        }

        // 디버깅 정보
        function debugInfo() {
            const debugInfo = {
                url: window.location.href,
                accessToken: currentAccessToken ? currentAccessToken.substring(0, 50) + '...' : '없음',
                refreshToken: currentRefreshToken ? currentRefreshToken.substring(0, 50) + '...' : '없음',
                cookies: document.cookie,
                userAgent: navigator.userAgent
            };
            
            const debugElement = document.getElementById('debugInfo');
            const contentElement = document.getElementById('debugInfoContent');
            
            contentElement.textContent = JSON.stringify(debugInfo, null, 2);
            debugElement.classList.remove('hidden');
        }

        // 유틸리티 함수들
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showNotification(message, type) {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(`${type.toUpperCase()}: ${message}`);
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').classList.add('hidden');
        }
    </script>
</body>
</html> 