<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HowAreYou - ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .token-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            max-height: 100px;
            overflow-y: auto;
        }
        .success-badge {
            background-color: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .error-badge {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .warning-badge {
            background-color: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">ğŸ” HowAreYou ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>
            <p class="text-gray-600 text-center">React ìŠ¤íƒ€ì¼ì˜ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</p>
        </header>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="hidden flex items-center justify-center py-12">
            <div class="loading-spinner"></div>
            <span class="ml-3 text-gray-600">ë¡œë”© ì¤‘...</span>
        </div>

        <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
        <div id="loginPage" class="max-w-md mx-auto">
            <div class="bg-white shadow-lg rounded-lg p-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">ë¡œê·¸ì¸</h2>
                    <p class="text-gray-600">í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
                </div>

                <!-- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
                        <input type="email" id="email" value="test@example.com" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" value="password123!" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="login()" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ë¡œê·¸ì¸
                    </button>
                </div>

                <!-- ì†Œì…œ ë¡œê·¸ì¸ -->
                <div class="space-y-3">
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">ë˜ëŠ”</span>
                        </div>
                    </div>
                    
                    <button onclick="socialLogin('google')" 
                            class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Googleë¡œ ë¡œê·¸ì¸
                    </button>
                    
                    <!-- OAuth2 ìƒíƒœ í‘œì‹œ -->
                    <div id="oauthStatus" class="hidden p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                            <span class="text-sm text-blue-700">OAuth2 ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</span>
                        </div>
                    </div>
                </div>

                <!-- í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´ -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-900 mb-2">í…ŒìŠ¤íŠ¸ ê³„ì •</h3>
                    <div class="text-xs text-blue-700 space-y-1">
                        <div>test@example.com / password123!</div>
                        <div>admin@example.com / admin123!</div>
                        <div>user1@example.com / user123!</div>
                    </div>
                    <div class="mt-3">
                        <button onclick="createDefaultAccounts()" 
                                class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm">
                            í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„±
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í™ˆ í˜ì´ì§€ (ë¡œê·¸ì¸ í›„) -->
        <div id="homePage" class="hidden max-w-4xl mx-auto">
            <!-- í—¤ë” -->
            <header class="bg-white shadow mb-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center py-6">
                        <h1 class="text-3xl font-bold text-gray-900">í™ˆ</h1>
                        <div class="flex space-x-3">
                            <button onclick="refreshToken()" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                í† í° ê°±ì‹ 
                            </button>
                            <button onclick="logout()" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <main class="space-y-6">
                <!-- ì‚¬ìš©ì ì •ë³´ ì¹´ë“œ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <div id="userAvatar" class="h-16 w-16 rounded-full bg-gray-300 flex items-center justify-center">
                            <span id="userInitial" class="text-gray-600 text-xl font-bold">U</span>
                        </div>
                        <div>
                            <h2 id="userName" class="text-2xl font-bold text-gray-900">ì‚¬ìš©ì</h2>
                            <p id="userEmail" class="text-gray-600">ì´ë©”ì¼</p>
                            <div id="profileStatus" class="mt-1"></div>
                        </div>
                    </div>

                    <!-- ì‚¬ìš©ì ìƒì„¸ ì •ë³´ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">ê¸°ë³¸ ì •ë³´</h3>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ìœ ì €ë„¤ì„</dt>
                                    <dd id="userMembername" class="text-sm text-gray-900">-</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ë‹‰ë„¤ì„</dt>
                                    <dd id="userNickname" class="text-sm text-gray-900">-</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ì—­í• </dt>
                                    <dd id="userRole" class="text-sm text-gray-900">-</dd>
                                </div>
                            </dl>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">ì¸ì¦ ì •ë³´</h3>
                            <dl class="space-y-3">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ì¸ì¦ ìƒíƒœ</dt>
                                    <dd id="authStatus" class="text-sm text-gray-900">-</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</dt>
                                    <dd id="lastLogin" class="text-sm text-gray-900">-</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>

                <!-- í† í° ì •ë³´ ì¹´ë“œ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">í† í° ì •ë³´</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                            <div id="accessToken" class="token-display">í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Refresh Token</label>
                            <div id="refreshToken" class="token-display">í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="copyAccessToken()" 
                                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                Access Token ë³µì‚¬
                            </button>
                            <button onclick="copyRefreshToken()" 
                                    class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                Refresh Token ë³µì‚¬
                            </button>
                            <button onclick="decodeToken()" 
                                    class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                í† í° ë””ì½”ë”©
                            </button>
                        </div>
                    </div>
                </div>

                <!-- API í…ŒìŠ¤íŠ¸ ì¹´ë“œ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">API í…ŒìŠ¤íŠ¸</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="testMyProfile()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            ë‚´ í”„ë¡œí•„ ì¡°íšŒ
                        </button>
                        <button onclick="testMemberStatus()" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            íšŒì› ìƒíƒœ ì¡°íšŒ
                        </button>
                        <button onclick="testMemberProfile()" 
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            ê³µê°œ í”„ë¡œí•„ ì¡°íšŒ
                        </button>
                        <button onclick="testProtectedEndpoint()" 
                                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸
                        </button>
                        <button onclick="testTokenValidation()" 
                                class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                            í† í° ìœ íš¨ì„± ê²€ì‚¬
                        </button>
                    </div>
                    <div id="apiResult" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                        <pre id="apiResultContent" class="text-sm text-gray-700"></pre>
                    </div>
                </div>

                <!-- ì¿ í‚¤ ë””ë²„ê¹… ì¹´ë“œ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ” ì¿ í‚¤ ë””ë²„ê¹…</h3>
                    <div class="space-y-4">
                        <button onclick="debugCookies()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            ì¿ í‚¤ ì •ë³´ í™•ì¸
                        </button>
                        <button onclick="clearAllCookies()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            ëª¨ë“  ì¿ í‚¤ ì‚­ì œ
                        </button>
                        <div id="cookieDebug" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                            <pre id="cookieDebugContent" class="text-sm text-gray-700"></pre>
                        </div>
                    </div>
                </div>

                <!-- ìºì‹œ ê´€ë¦¬ ì¹´ë“œ -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ—„ï¸ ìºì‹œ ê´€ë¦¬</h3>
                    <div class="space-y-4">
                        <button onclick="checkCacheHealth()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            ìºì‹œ ìƒíƒœ í™•ì¸
                        </button>
                        <button onclick="migrateCache()" 
                                class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
                            ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜
                        </button>
                        <button onclick="clearAllCache()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            ëª¨ë“  ìºì‹œ ì‚­ì œ
                        </button>
                        <div id="cacheDebug" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                            <pre id="cacheDebugContent" class="text-sm text-gray-700"></pre>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- í† í° ë””ì½”ë”© ëª¨ë‹¬ -->
        <div id="tokenModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">JWT í† í° ë””ì½”ë”©</h3>
                    <div id="tokenDecodeResult" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                        <pre class="text-sm text-gray-700"></pre>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="closeTokenModal()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let currentUser = JSON.parse(localStorage.getItem('user')) || null;
        let currentAccessToken = localStorage.getItem('accessToken') || '';
        let currentRefreshToken = localStorage.getItem('refreshToken') || '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            debugCookieReading(); // ì¿ í‚¤ ì½ê¸° ë””ë²„ê¹…
            checkAuthStatus();
            checkDatabaseStatus(); // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
            handleOAuthSuccess(); // OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        };

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        async function checkAuthStatus() {
            showLoading(true);
            
            try {
                // localStorageì—ì„œ í† í° í™•ì¸
                if (currentAccessToken) {
                    console.log('localStorageì—ì„œ Access Token ë°œê²¬, ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...');
                    // Access Tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    await loadUserInfo();
                    showHomePage();
                } else {
                    // ì¿ í‚¤ì—ì„œ Refresh Token í™•ì¸
                    currentRefreshToken = getCookie('Refresh') || '';
                    
                    if (currentRefreshToken) {
                        console.log('ì¿ í‚¤ì—ì„œ Refresh Token ë°œê²¬, í† í° ê°±ì‹  ì‹œë„...');
                        // í† í° ê°±ì‹  ì‹œë„
                        await refreshToken();
                    } else {
                        console.log('ì €ì¥ëœ í† í° ì—†ìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ í‘œì‹œ');
                        showLoginPage();
                    }
                }
            } catch (error) {
                console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                // í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ localStorage í´ë¦¬ì–´
                clearStoredTokens();
                showLoginPage();
            } finally {
                showLoading(false);
            }
        }

        // ë¡œê·¸ì¸ í•¨ìˆ˜
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // ì¿ í‚¤ í¬í•¨
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (response.ok) {
                    // í† í° ì €ì¥
                    currentAccessToken = response.headers.get('Authorization')?.replace('Bearer ', '') || '';
                    
                    // HttpOnly ì¿ í‚¤ëŠ” JavaScriptì—ì„œ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê°’ ì‚¬ìš©
                    currentRefreshToken = result.refresh || getCookie('Refresh') || '';
                    
                    // localStorageì— í† í° ì €ì¥
                    localStorage.setItem('accessToken', currentAccessToken);
                    localStorage.setItem('refreshToken', currentRefreshToken);
                    
                    // ì¿ í‚¤ ë””ë²„ê¹…
                    console.log('ë¡œê·¸ì¸ í›„ ëª¨ë“  ì¿ í‚¤:', document.cookie);
                    console.log('ë¡œê·¸ì¸ í›„ Refresh í† í° (ì‘ë‹µì—ì„œ):', result.refresh);
                    console.log('ë¡œê·¸ì¸ í›„ Refresh í† í° (ì¿ í‚¤ì—ì„œ):', currentRefreshToken);
                    console.log('localStorageì— í† í° ì €ì¥ ì™„ë£Œ');
                    
                    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                    await loadUserInfo();
                    
                    // ê³µí†µ ì¸ì¦ ì •ë³´ ì €ì¥
                    if (window.authManager) {
                        window.authManager.saveAuthInfo(result.user || currentUser, currentAccessToken);
                    }
                    
                    showHomePage();
                    showNotification('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                } else {
                    showNotification(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                showNotification(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ì†Œì…œ ë¡œê·¸ì¸
        function socialLogin(provider) {
            // OAuth2 ìƒíƒœ í‘œì‹œ
            document.getElementById('oauthStatus').classList.remove('hidden');
            
            // OAuth2 ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = `/oauth2/authorization/${provider}`;
        }

        // í† í° ê°±ì‹ 
        async function refreshToken() {
            try {
                console.log('í† í° ê°±ì‹  ìš”ì²­ ì‹œì‘...');
                console.log('í˜„ì¬ ì¿ í‚¤ ìƒíƒœ:', document.cookie);
                
                // HttpOnly ì¿ í‚¤ëŠ” ìë™ìœ¼ë¡œ ì „ì†¡ë˜ë¯€ë¡œ ë³„ë„ í—¤ë” ì„¤ì • ë¶ˆí•„ìš”
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include' // ì¿ í‚¤ í¬í•¨
                });

                console.log('í† í° ê°±ì‹  ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('í† í° ê°±ì‹  ì‘ë‹µ í—¤ë”:', response.headers);

                if (response.ok) {
                    currentAccessToken = response.headers.get('Authorization')?.replace('Bearer ', '') || '';
                    console.log('ìƒˆë¡œìš´ Access Token:', currentAccessToken ? currentAccessToken.substring(0, 50) + '...' : 'ì—†ìŒ');
                    updateTokenDisplay();
                    showNotification('í† í° ê°±ì‹  ì„±ê³µ!', 'success');
                    return true;
                } else {
                    const result = await response.json();
                    console.error('í† í° ê°±ì‹  ì‹¤íŒ¨ ì‘ë‹µ:', result);
                    throw new Error(result.message || 'í† í° ê°±ì‹  ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('í† í° ê°±ì‹  ì¤‘ ì˜¤ë¥˜:', error);
                showNotification(`í† í° ê°±ì‹  ì‹¤íŒ¨: ${error.message}`, 'error');
                throw error;
            }
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            if (!currentAccessToken) {
                throw new Error('Access Tokenì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            try {
                const response = await fetch('/api/members/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    // localStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserDisplay();
                    console.log('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° localStorage ì €ì¥ ì™„ë£Œ');
                } else {
                    console.warn('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', response.status);
                    // í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ localStorage í´ë¦¬ì–´
                    if (response.status === 401) {
                        clearStoredTokens();
                    }
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            if (!currentRefreshToken) {
                showLoginPage();
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Cookie': `Refresh=${currentRefreshToken}`
                    }
                });

                if (response.ok) {
                    clearStoredTokens(); // localStorageë„ í´ë¦¬ì–´
                    showLoginPage();
                    showNotification('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ!', 'success');
                } else {
                    const result = await response.json();
                    showNotification(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        async function testMemberStatus() {
            // í˜„ì¬ ì‚¬ìš©ìì˜ membernameì„ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
            const membername = currentUser?.membername || 'test';
            await testAPI(`/api/members/${membername}/status`, 'íšŒì› ìƒíƒœ ì¡°íšŒ');
        }

        async function testMemberProfile() {
            // í˜„ì¬ ì‚¬ìš©ìì˜ membernameì„ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
            const membername = currentUser?.membername || 'test';
            await testAPI(`/api/members/${membername}`, 'ê³µê°œ í”„ë¡œí•„ ì¡°íšŒ');
        }

        async function testMyProfile() {
            await testAPI('/api/members/me', 'ë‚´ í”„ë¡œí•„ ì¡°íšŒ');
        }

        async function testProtectedEndpoint() {
            await testAPI('/api/test/protected', 'ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸');
        }

        async function testTokenValidation() {
            await testAPI('/api/test/token/validate', 'í† í° ìœ íš¨ì„± ê²€ì‚¬');
        }

        // ê³µí†µ API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testAPI(endpoint, description) {
            if (!currentAccessToken) {
                showNotification('Access Tokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`
                    },
                    credentials: 'include' // ì¿ í‚¤ í¬í•¨
                });

                const result = await response.json();
                
                if (response.ok) {
                    showApiResult(`${description} ì„±ê³µ!`, result, 'success');
                } else {
                    showApiResult(`${description} ì‹¤íŒ¨`, result, 'error');
                }
            } catch (error) {
                showApiResult(`${description} ì˜¤ë¥˜`, { error: error.message }, 'error');
            }
        }

        // í† í° ë³µì‚¬ í•¨ìˆ˜ë“¤
        function copyAccessToken() {
            if (currentAccessToken) {
                navigator.clipboard.writeText(currentAccessToken);
                showNotification('Access Tokenì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        function copyRefreshToken() {
            if (currentRefreshToken) {
                navigator.clipboard.writeText(currentRefreshToken);
                showNotification('Refresh Tokenì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // í† í° ë””ì½”ë”©
        function decodeToken() {
            if (!currentAccessToken) {
                showNotification('Access Tokenì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const parts = currentAccessToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ JWT í˜•ì‹');
                }

                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));

                const decodeResult = {
                    header: header,
                    payload: payload,
                    token: currentAccessToken
                };

                document.getElementById('tokenDecodeResult').innerHTML = 
                    `<pre class="text-sm text-gray-700">${JSON.stringify(decodeResult, null, 2)}</pre>`;
                document.getElementById('tokenModal').classList.remove('hidden');
            } catch (error) {
                showNotification(`í† í° ë””ì½”ë”© ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        function updateUserDisplay() {
            if (!currentUser) return;

            // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´
            document.getElementById('userName').textContent = currentUser.nickname || currentUser.membername || 'ì‚¬ìš©ì';
            document.getElementById('userEmail').textContent = currentUser.email || '-';
            document.getElementById('userMembername').textContent = currentUser.membername || '-';
            document.getElementById('userNickname').textContent = currentUser.nickname || '-';
            document.getElementById('userRole').textContent = currentUser.role || '-';

            // ì‚¬ìš©ì ì´ë‹ˆì…œ
            const initial = (currentUser.nickname || currentUser.membername || 'U')[0].toUpperCase();
            document.getElementById('userInitial').textContent = initial;

            // í”„ë¡œí•„ ìƒíƒœ
            const statusElement = document.getElementById('profileStatus');
            if (currentUser.isProfileComplete) {
                statusElement.innerHTML = '<span class="success-badge">í”„ë¡œí•„ ì™„ì„±</span>';
            } else {
                statusElement.innerHTML = '<span class="warning-badge">í”„ë¡œí•„ ë¯¸ì™„ì„±</span>';
            }

            // ì¸ì¦ ìƒíƒœ
            document.getElementById('authStatus').innerHTML = '<span class="success-badge">ì¸ì¦ë¨</span>';
            document.getElementById('lastLogin').textContent = new Date().toLocaleString();
        }

        function updateTokenDisplay() {
            document.getElementById('accessToken').textContent = currentAccessToken || 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤.';
            document.getElementById('refreshToken').textContent = currentRefreshToken || 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤.';
        }

        function clearTokens() {
            currentAccessToken = '';
            currentRefreshToken = '';
            currentUser = null;
            updateTokenDisplay();
        }

        function clearStoredTokens() {
            // localStorage í´ë¦¬ì–´
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            
            // ì „ì—­ ë³€ìˆ˜ í´ë¦¬ì–´
            currentAccessToken = '';
            currentRefreshToken = '';
            currentUser = null;
            
            updateTokenDisplay();
            console.log('localStorage ë° ì „ì—­ ë³€ìˆ˜ í´ë¦¬ì–´ ì™„ë£Œ');
        }

        // í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜ë“¤
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('homePage').classList.add('hidden');
        }

        function showHomePage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            updateTokenDisplay();
        }

        function showApiResult(title, data, type) {
            const resultElement = document.getElementById('apiResult');
            const contentElement = document.getElementById('apiResultContent');
            
            const typeClass = type === 'success' ? 'text-green-700' : 'text-red-700';
            contentElement.className = `text-sm ${typeClass}`;
            contentElement.textContent = `${title}\n\n${JSON.stringify(data, null, 2)}`;
            
            resultElement.classList.remove('hidden');
        }

        function showNotification(message, type) {
            // ê°„ë‹¨í•œ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‚¬ìš©)
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').classList.add('hidden');
        }

        // í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„±
        async function createDefaultAccounts() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/test/create-default-accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('âœ… í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„± ì„±ê³µ!', 'success');
                    console.log('í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„± ê²°ê³¼:', result);
                } else {
                    showNotification(`âŒ í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„± ì‹¤íŒ¨: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        async function handleOAuthSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const oauthSuccess = urlParams.get('oauth_success');
            const provider = urlParams.get('provider');
            const profileCompleted = urlParams.get('profile_completed');
            const accessToken = urlParams.get('access_token');
            
            if (oauthSuccess === 'true') {
                showNotification(`âœ… ${provider} OAuth2 ë¡œê·¸ì¸ ì„±ê³µ!`, 'success');
                
                // URL íŒŒë¼ë¯¸í„° ì •ë¦¬
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // ì¿ í‚¤ ë””ë²„ê¹…
                console.log('=== OAuth2 ë¡œê·¸ì¸ í›„ ì¿ í‚¤ ìƒíƒœ ===');
                console.log('ëª¨ë“  ì¿ í‚¤:', document.cookie);
                console.log('Refresh ì¿ í‚¤ (HttpOnlyì´ë¯€ë¡œ ì½ì„ ìˆ˜ ì—†ìŒ):', getCookie('Refresh'));
                console.log('URLì—ì„œ ë°›ì€ Access Token:', accessToken ? accessToken.substring(0, 50) + '...' : 'ì—†ìŒ');
                
                // OAuth2 ë¡œê·¸ì¸ í›„ ì²˜ë¦¬
                try {
                    console.log('OAuth2 ë¡œê·¸ì¸ í›„ ì²˜ë¦¬ ì‹œì‘...');
                    
                    // URLì—ì„œ ë°›ì€ Access Tokenì´ ìˆìœ¼ë©´ ì‚¬ìš©
                    if (accessToken) {
                        console.log('URLì—ì„œ ë°›ì€ Access Token ì‚¬ìš©');
                        currentAccessToken = accessToken;
                        // localStorageì— í† í° ì €ì¥
                        localStorage.setItem('accessToken', currentAccessToken);
                        await loadUserInfo();
                        showHomePage();
                    } else {
                        console.log('Access Tokenì´ ì—†ìœ¼ë¯€ë¡œ í† í° ê°±ì‹  ì‹œë„...');
                        // ì ì‹œ ëŒ€ê¸° (ì¿ í‚¤ ì„¤ì • ì™„ë£Œ ëŒ€ê¸°)
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // í† í° ê°±ì‹  ì‹œë„
                        await refreshToken();
                        await loadUserInfo();
                        showHomePage();
                    }
                } catch (error) {
                    console.error('OAuth2 ë¡œê·¸ì¸ í›„ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                    showNotification('OAuth2 ë¡œê·¸ì¸ ì„±ê³µ! í† í° ê°±ì‹ ì€ ìˆ˜ë™ìœ¼ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                }
            }
        }

        // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/test/db-status');
                const result = await response.json();
                
                if (response.ok) {
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ:', result);
                } else {
                    console.error('ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', result);
                }
            } catch (error) {
                console.error('ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì¿ í‚¤ ë””ë²„ê¹… í•¨ìˆ˜ë“¤
        function debugCookies() {
            const allCookies = document.cookie;
            const refreshCookie = getCookie('Refresh');
            
            const debugInfo = {
                allCookies: allCookies,
                refreshCookie: refreshCookie,
                refreshCookieLength: refreshCookie ? refreshCookie.length : 0,
                currentRefreshToken: currentRefreshToken,
                currentAccessToken: currentAccessToken ? currentAccessToken.substring(0, 50) + '...' : 'ì—†ìŒ',
                url: window.location.href,
                userAgent: navigator.userAgent
            };
            
            const debugElement = document.getElementById('cookieDebug');
            const contentElement = document.getElementById('cookieDebugContent');
            
            contentElement.textContent = JSON.stringify(debugInfo, null, 2);
            debugElement.classList.remove('hidden');
            
            console.log('ì¿ í‚¤ ë””ë²„ê¹… ì •ë³´:', debugInfo);
        }

        function clearAllCookies() {
            const cookies = document.cookie.split(";");
            
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            }
            
            // localStorageë„ í•¨ê»˜ í´ë¦¬ì–´
            clearStoredTokens();
            
            showNotification('ëª¨ë“  ì¿ í‚¤ì™€ localStorageê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            console.log('ëª¨ë“  ì¿ í‚¤ ë° localStorage ì‚­ì œ ì™„ë£Œ');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        // ì¿ í‚¤ ì½ê¸° ë””ë²„ê¹…
        function debugCookieReading() {
            console.log('=== ì¿ í‚¤ ì½ê¸° ë””ë²„ê¹… ===');
            console.log('ì „ì²´ ì¿ í‚¤:', document.cookie);
            console.log('Refresh ì¿ í‚¤ ì§ì ‘ ì½ê¸°:', getCookie('Refresh'));
            
            // ì¿ í‚¤ë¥¼ í•˜ë‚˜ì”© íŒŒì‹±í•´ì„œ í™•ì¸
            const cookies = document.cookie.split(';');
            cookies.forEach(cookie => {
                const trimmed = cookie.trim();
                console.log('ì¿ í‚¤:', trimmed);
                if (trimmed.startsWith('Refresh=')) {
                    console.log('Refresh í† í° ë°œê²¬:', trimmed.substring(8));
                }
            });
        }

        // ìºì‹œ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function checkCacheHealth() {
            try {
                const response = await fetch('/api/test/cache-health', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                const debugElement = document.getElementById('cacheDebug');
                const contentElement = document.getElementById('cacheDebugContent');
                
                contentElement.textContent = JSON.stringify(result, null, 2);
                debugElement.classList.remove('hidden');
                
                if (result.success) {
                    showNotification(result.message, result.cacheHealthy ? 'success' : 'warning');
                } else {
                    showNotification('ìºì‹œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + result.message, 'error');
                }
                
                console.log('ìºì‹œ ìƒíƒœ í™•ì¸ ê²°ê³¼:', result);
            } catch (error) {
                console.error('ìºì‹œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                showNotification('ìºì‹œ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        async function clearAllCache() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/test/clear-cache', {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                
                const debugElement = document.getElementById('cacheDebug');
                const contentElement = document.getElementById('cacheDebugContent');
                
                contentElement.textContent = JSON.stringify(result, null, 2);
                debugElement.classList.remove('hidden');
                
                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification('ìºì‹œ ì‚­ì œ ì‹¤íŒ¨: ' + result.message, 'error');
                }
                
                console.log('ìºì‹œ ì‚­ì œ ê²°ê³¼:', result);
            } catch (error) {
                console.error('ìºì‹œ ì‚­ì œ ì˜¤ë¥˜:', error);
                showNotification('ìºì‹œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        async function migrateCache() {
            if (!confirm('ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ LinkedHashMap ìºì‹œê°€ ìƒˆë¡œìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/test/migrate-cache', {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                
                const debugElement = document.getElementById('cacheDebug');
                const contentElement = document.getElementById('cacheDebugContent');
                
                contentElement.textContent = JSON.stringify(result, null, 2);
                debugElement.classList.remove('hidden');
                
                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification('ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ' + result.message, 'error');
                }
                
                console.log('ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼:', result);
            } catch (error) {
                console.error('ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
                showNotification('ìºì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
    </script>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
    <script src="/js/auth-common.js"></script>
    <script src="/js/common-header.js"></script>
</body>
</html> 